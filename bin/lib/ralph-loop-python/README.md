# Ralph Loop Python Library

This directory contains standalone Python scripts extracted from bash heredocs in the ralph-loop tool. These scripts provide robust JSON parsing, text extraction, and state management functionality.

## Scripts

### json_extractor.py
**Purpose:** Extract JSON objects containing specific keys from files with arbitrary nesting depth.

**Usage:**
```bash
python3 json_extractor.py <file_path> <json_type>
```

**Example:**
```bash
python3 json_extractor.py output.txt RALPH_VALIDATION
```

**Features:**
- Handles markdown code blocks
- Bracket-matching for arbitrary nesting depth
- Robust parsing of complex JSON structures

---

### json_field.py
**Purpose:** Generic utility for extracting specific fields from JSON data.

**Usage:**
```bash
echo "$json" | python3 json_field.py {verdict|feedback|remaining|blocked_count|blocked_tasks|escape}
```

**Examples:**
```bash
# Extract verdict
echo "$json" | python3 json_field.py verdict

# Escape string for JSON
echo "$text" | python3 json_field.py escape
```

**Supported Fields:**
- `verdict` - Extract RALPH_VALIDATION.verdict
- `feedback` - Extract RALPH_VALIDATION.feedback
- `remaining` - Extract RALPH_VALIDATION.tasks_analysis.remaining_unchecked
- `blocked_count` - Extract RALPH_VALIDATION.tasks_analysis.confirmed_blocked
- `blocked_tasks` - Extract and format RALPH_VALIDATION.blocked_tasks list
- `escape` - Escape stdin content for JSON (does not require JSON input)

---

### state_parser.py
**Purpose:** Parse ralph-loop state JSON files and output shell variables or formatted status.

**Usage:**
```bash
# Load state and output shell variables
python3 state_parser.py load <state_file>

# Display formatted status
python3 state_parser.py status <state_file>

# Get stored status value
python3 state_parser.py check <state_file>
```

**Example:**
```bash
# Load state in bash script
eval "$(python3 state_parser.py load .ralph-loop/current-state.json)"

# Show status
python3 state_parser.py status .ralph-loop/current-state.json
```

---

### stream_parser.py
**Purpose:** Extract text content from JSON/JSONL stream outputs generated by claude and codex.

**Usage:**
```bash
# Parse claude stream-json
python3 stream_parser.py stream <json_file> <output_file>

# Parse codex JSONL
python3 stream_parser.py codex <json_file> <output_file>
```

**Example:**
```bash
python3 stream_parser.py stream output.stream.json output.txt
python3 stream_parser.py codex output.jsonl output.txt
```

---

### learnings_extractor.py
**Purpose:** Extract content from RALPH_LEARNINGS sections in implementation output files.

**Usage:**
```bash
python3 learnings_extractor.py <output_file>
```

**Example:**
```bash
python3 learnings_extractor.py .ralph-loop/impl-output-001.txt
```

**Note:** Learnings are optional; script exits silently if no learnings found.

---

## Integration with Bash Scripts

These Python scripts are called from bash scripts in `bin/lib/ralph-loop/`. The `PYTHON_DIR` environment variable is set by the main ralph-loop.sh script:

```bash
PYTHON_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/lib/ralph-loop-python"
```

Individual library scripts have a fallback default:

```bash
: "${PYTHON_DIR:=$(dirname "${BASH_SOURCE[0]}")/../ralph-loop-python}"
```

## Benefits of Extraction

1. **Maintainability:** Easier to edit, test, and debug Python code in standalone files
2. **Reusability:** Scripts can be tested independently and reused in other tools
3. **IDE Support:** Better syntax highlighting, linting, and code completion
4. **Testability:** Each script can be unit tested separately
5. **Clarity:** Bash scripts are cleaner without large heredoc blocks

## Testing

Each script can be tested independently:

```bash
# Test json_field.py
echo '{"RALPH_VALIDATION": {"verdict": "PASS"}}' | python3 json_field.py verdict

# Test escape
echo 'test "string"' | python3 json_field.py escape

# Test state parser (requires a real state file)
python3 state_parser.py status .ralph-loop/current-state.json
```

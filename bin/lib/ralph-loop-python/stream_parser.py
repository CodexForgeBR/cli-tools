#!/usr/bin/env python3
"""
Stream parser for ralph-loop AI output.

Extracts text content from JSON/JSONL stream outputs generated by claude and codex.
Handles both stream-json format (claude) and JSONL format (codex).

Usage:
    stream_parser.py stream <json_file> <output_file>  - Parse claude stream-json
    stream_parser.py codex <json_file> <output_file>   - Parse codex JSONL

Exit codes: 0 on success, 1 on failure
"""
import sys
import json


def extract_text_from_stream_json(json_file, output_file):
    """Extract text from claude stream-json format"""
    text_parts = []
    result_text = ""

    try:
        with open(json_file, 'r') as f:
            for line in f:
                line = line.strip()
                if not line:
                    continue
                try:
                    obj = json.loads(line)
                    msg_type = obj.get('type', '')

                    # Collect assistant text messages
                    if msg_type == 'assistant' and 'message' in obj:
                        for content in obj['message'].get('content', []):
                            if content.get('type') == 'text':
                                text_parts.append(content.get('text', ''))
                            elif content.get('type') == 'tool_use':
                                tool_name = content.get('name', 'unknown')
                                tool_input = content.get('input', {})
                                try:
                                    input_str = json.dumps(tool_input, ensure_ascii=False)
                                except (TypeError, ValueError):
                                    input_str = str(tool_input)
                                text_parts.append(f'[Tool Call: {tool_name}] {input_str}')

                    # Get final result
                    if msg_type == 'result':
                        result_text = obj.get('result', '')
                except json.JSONDecodeError:
                    continue

        # Prefer collected text, fall back to result
        final_text = '\n'.join(text_parts) if text_parts else result_text

        with open(output_file, 'w') as f:
            f.write(final_text)

        sys.exit(0)

    except Exception as e:
        print(f"Error extracting text from stream: {e}", file=sys.stderr)
        sys.exit(1)


def extract_text_from_codex_jsonl(json_file, output_file):
    """Extract text from codex JSONL format"""
    text_parts = []

    def record_text(text):
        if text:
            text_parts.append(text)

    try:
        with open(json_file, 'r') as f:
            for line in f:
                line = line.strip()
                if not line:
                    continue
                try:
                    obj = json.loads(line)
                except json.JSONDecodeError:
                    continue

                if obj.get('type') == 'item.completed':
                    item = obj.get('item', {})
                    item_type = item.get('type', '')
                    if item_type in ('agent_message', 'assistant_message'):
                        record_text(item.get('text', ''))
                    elif item_type == 'function_call':
                        func_name = item.get('name', 'unknown')
                        func_args = item.get('arguments', '{}')
                        record_text(f'[Tool Call: {func_name}] {func_args}')

        final_text = '\n'.join(text_parts).strip()
        if not final_text:
            sys.exit(1)

        with open(output_file, 'w') as f:
            f.write(final_text)

        sys.exit(0)
    except Exception as e:
        print(f"Error extracting text: {e}", file=sys.stderr)
        sys.exit(1)


def main():
    if len(sys.argv) != 4:
        print("Usage: stream_parser.py {stream|codex} <json_file> <output_file>", file=sys.stderr)
        sys.exit(1)

    parser_type = sys.argv[1]
    json_file = sys.argv[2]
    output_file = sys.argv[3]

    if parser_type == 'stream':
        extract_text_from_stream_json(json_file, output_file)
    elif parser_type == 'codex':
        extract_text_from_codex_jsonl(json_file, output_file)
    else:
        print(f"Unknown parser type: {parser_type}", file=sys.stderr)
        sys.exit(1)


if __name__ == '__main__':
    main()

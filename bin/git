#!/bin/bash

# git wrapper script - Blocks destructive commands when called from automated CLIs
# Created for CodexForge CLI Tools
# Repository: https://github.com/CodexForgeBR/cli-tools

DEBUG_LOG="$HOME/.git-wrapper-debug.log"

# Function to check entire process ancestry for automated CLI tools
check_process_tree() {
    local pid=$1
    local depth=0
    local max_depth=20

    echo "[$(date)] Starting process tree check from PID=$pid" >> "$DEBUG_LOG"

    while [[ $pid -gt 1 ]] && [[ $depth -lt $max_depth ]]; do
        local cmd=$(ps -o comm= -p $pid 2>/dev/null)
        local cmdline=$(ps -o args= -p $pid 2>/dev/null)

        echo "  Depth $depth: PID=$pid, cmd='$cmd'" >> "$DEBUG_LOG"

        # Check for Claude Code, Codex CLI, Gemini CLI markers
        if [[ "$cmd" =~ (claude|codex|gemini|node|python) ]] || \
           [[ "$cmdline" =~ (claude-code|codex-cli|gemini-cli|@anthropics/claude|/codex|/gemini) ]]; then
            echo "  MATCHED! Detected: $cmd" >> "$DEBUG_LOG"
            echo "$cmd"
            return 0
        fi

        # Move to parent process
        pid=$(ps -o ppid= -p $pid 2>/dev/null | tr -d ' ')
        ((depth++))
    done

    echo "  No match found in process tree" >> "$DEBUG_LOG"
    return 1
}

# Function to check if command is destructive
is_destructive_command() {
    local args="$*"

    # Tier 1: Critical blocklist

    # 1. Bypass hooks (--no-verify or -n flag)
    if [[ "$args" =~ --no-verify ]] || [[ "$args" =~ (^| )-n($| ) ]]; then
        echo "BLOCKED: git commit --no-verify bypasses pre-commit hooks (Husky.Net validation)"
        return 0
    fi

    # 2. Hard reset
    if [[ "$args" =~ reset.*--hard ]]; then
        echo "BLOCKED: git reset --hard destroys uncommitted changes permanently"
        return 0
    fi

    # 3. Clean (any variant: -f, -d, -x, combined flags)
    if [[ "$args" =~ clean ]]; then
        if [[ "$args" =~ -[fdxFDX] ]] || [[ "$args" =~ --force ]]; then
            echo "BLOCKED: git clean -f/-d/-x deletes untracked/ignored files permanently"
            return 0
        fi
    fi

    # 4. Force push (--force or -f flag)
    if [[ "$args" =~ push ]]; then
        if [[ "$args" =~ --force($| ) ]] || [[ "$args" =~ (^| )-f($| ) ]]; then
            echo "BLOCKED: git push --force rewrites remote history (dangerous on shared branches)"
            return 0
        fi

        # 5. Force-with-lease (still rewrites history)
        if [[ "$args" =~ --force-with-lease ]]; then
            echo "BLOCKED: git push --force-with-lease still rewrites remote history"
            return 0
        fi
    fi

    # Not destructive
    return 1
}

# Main logic
detected_cli=""
if detected_cli=$(check_process_tree $$); then
    # We're in an automated CLI context - check for destructive commands
    echo "[$(date)] Detected automated CLI: $detected_cli" >> "$DEBUG_LOG"
    echo "[$(date)] Command: git $*" >> "$DEBUG_LOG"

    # Check if this is a destructive operation
    if error_msg=$(is_destructive_command "git $*"); then
        echo "" >&2
        echo "========================================" >&2
        echo "GIT WRAPPER: DESTRUCTIVE COMMAND BLOCKED" >&2
        echo "========================================" >&2
        echo "" >&2
        echo "$error_msg" >&2
        echo "" >&2
        echo "Detected automated CLI tool: $detected_cli" >&2
        echo "" >&2
        echo "This protection prevents Claude Code and other automated tools" >&2
        echo "from running destructive git commands that could:" >&2
        echo "  - Bypass security hooks (pre-commit validation)" >&2
        echo "  - Rewrite git history (force push)" >&2
        echo "  - Permanently delete uncommitted work (reset --hard, clean -f)" >&2
        echo "" >&2
        echo "To bypass this protection (if absolutely necessary):" >&2
        echo "  1. Run the command from your regular terminal (not from Claude)" >&2
        echo "  2. Or use the real git binary: /opt/homebrew/bin/git $*" >&2
        echo "" >&2
        echo "See ~/.git-wrapper-debug.log for details" >&2
        echo "========================================" >&2
        echo "" >&2

        echo "[$(date)] BLOCKED destructive command" >> "$DEBUG_LOG"
        exit 1
    fi

    echo "[$(date)] Command allowed (not destructive)" >> "$DEBUG_LOG"
fi

# Execute real git command (for safe commands or non-automated context)
# Prefer Homebrew git over system git
if [[ -x /opt/homebrew/bin/git ]]; then
    exec /opt/homebrew/bin/git "$@"
else
    exec /usr/bin/git "$@"
fi
